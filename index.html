<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Vikram Samvat Converter (Accurate)</title>

<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
:root {
  --primary: #1e88e5;
  --border: #ddd;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 15px;
  background: #fafafa;
}

h2 {
  text-align: center;
}

.section {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.section h3 {
  margin-top: 0;
}

.form-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

label {
  font-size: 0.9rem;
}

input {
  flex: 1;
  padding: 10px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid var(--border);
  min-width: 120px;
}

button {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

.output {
  margin-top: 10px;
  font-weight: 600;
  word-wrap: break-word;
}

/* Mobile adjustments */
@media (max-width: 600px) {
  body {
    padding: 10px;
  }

  h2 {
    font-size: 1.4rem;
  }

  .section {
    padding: 12px;
  }

  input, button {
    font-size: 1rem;
  }
}
</style>
</head>

<body>

<h2>Accurate Vikram Samvat Converter</h2>

<div class="section">
  <h3>Gregorian → Vikram Samvat</h3>
  <div class="form-row">
    <input type="date" id="g2v_date">
  </div>
  <button onclick="convertG2V()">Convert</button>
  <div class="output" id="g2v_out"></div>
</div>

<div class="section">
  <h3>Vikram Samvat → Gregorian</h3>
  <div class="form-row">
    <input placeholder="VS Year" id="vs_year">
    <input placeholder="VS Month (1-12)" id="vs_month">
    <input placeholder="VS Day (Tithi)" id="vs_day">
  </div>
  <button onclick="convertV2G()">Convert</button>
  <div class="output" id="v2g_out"></div>
</div>

<div class="section">
  <h3>Days Between Two Vikram Samvat Dates</h3>

  <strong>Date 1</strong>
  <div class="form-row">
    <input placeholder="Year" id="d1y">
    <input placeholder="Month" id="d1m">
    <input placeholder="Day" id="d1d">
  </div>

  <strong>Date 2</strong>
  <div class="form-row">
    <input placeholder="Year" id="d2y">
    <input placeholder="Month" id="d2m">
    <input placeholder="Day" id="d2d">
  </div>

  <button onclick="daysBetweenVS()">Calculate</button>
  <div class="output" id="days_out"></div>
</div>

<script>
const IST_OFFSET = 5.5 / 24;
const vsMonths = [
  "Chaitra","Vaishakha","Jyeshtha","Ashadha",
  "Shravana","Bhadrapada","Ashwin","Kartika",
  "Margashirsha","Pausha","Magha","Phalguna"
];

function jd(date) {
  const t = Astronomy.MakeTime(date);
  return t.ut + IST_OFFSET;
}

function sunLon(jd) {
  const time = Astronomy.MakeTime(new Date(jd * 86400000));
  const vec = Astronomy.GeoVector(Astronomy.Body.Sun, time, false);
  return Astronomy.Ecliptic(vec).elon;
}

function moonLon(jd) {
  const time = Astronomy.MakeTime(new Date(jd * 86400000));
  const vec = Astronomy.GeoVector(Astronomy.Body.Moon, time, false);
  return Astronomy.Ecliptic(vec).elon;
}

function sunLon1(jd) {
  const time = Astronomy.MakeTime(new Date(jd * 86400000));
  const eq = Astronomy.Equator(Astronomy.Body.Sun, time, null, true, false);
  const ecl = Astronomy.Ecliptic(eq);
  return ecl.elon;
}

function moonLon2(jd) {
  const time = Astronomy.MakeTime(new Date(jd * 86400000));
  const eq = Astronomy.Equator(Astronomy.Body.Moon, time, null, true, false);
  const ecl = Astronomy.Ecliptic(eq);
  return ecl.elon;
}

function tithi(jd) {
  return Math.floor(((moonLon(jd) - sunLon(jd) + 360) % 360) / 12) + 1;
}

function sankranti(jd1, jd2) {
  return Math.floor(sunLon(jd1)/30) !== Math.floor(sunLon(jd2)/30);
}

function isAdhikMonth(jdStart) {
  for (let i = 0; i < 30; i++) {
    if (sankranti(jdStart+i, jdStart+i+1)) return false;
  }
  return true;
}

function gregorianToVS(date) {
  let j = jd(date);
  let t = tithi(j);
  let paksha = t <= 15 ? "Shukla" : "Krishna";

  let purnimaJD = j;
  while (tithi(purnimaJD) !== 15) purnimaJD--;

  let monthIndex = Math.floor(sunLon(purnimaJD) / 30);
  let adhik = isAdhikMonth(purnimaJD - 15);

  let vsYear = date.getMonth() >= 3
    ? date.getFullYear() + 57
    : date.getFullYear() + 56;

  return {
    year: vsYear,
    month: vsMonths[monthIndex],
    monthIndex: monthIndex + 1,
    adhik,
    tithi: t,
    paksha
  };
}
function pakshaDay(tithi) {
  return tithi <= 15 ? tithi : tithi - 15;
}
function vsToGregorian(vy, vm, vd) {
  let approxYear = vy - 57;
  let date = new Date(approxYear, vm - 1, vd);

  for (let i = 0; i < 370; i++) {
    let g = gregorianToVS(date);
    if (g.year === vy && g.monthIndex === vm && g.tithi === vd)
      return date;
    date.setDate(date.getDate() + 1);
  }
  return null;
}

function convertG2V() {
  let d = new Date(g2v_date.value);
  let v = gregorianToVS(d);

  g2v_out.innerHTML =
    `VS ${v.year}, ${v.month}${v.adhik ? " (Adhik)" : ""} ${v.paksha} Paksha – Day ${pakshaDay(v.tithi)}`;
}

  
function convertV2G() {
  let g = vsToGregorian(+vs_year.value, +vs_month.value, +vs_day.value);
  v2g_out.innerHTML = g ? g.toDateString() : "Date not found";
}

function daysBetweenVS() {
  let d1 = vsToGregorian(+d1y.value, +d1m.value, +d1d.value);
  let d2 = vsToGregorian(+d2y.value, +d2m.value, +d2d.value);
  let days = Math.abs((d2 - d1) / (1000 * 60 * 60 * 24));
  days_out.innerHTML = `Total days: ${days}`;
}

/* EXPOSE FUNCTIONS TO GLOBAL SCOPE */
window.convertG2V = convertG2V;
window.convertV2G = convertV2G;
window.daysBetweenVS = daysBetweenVS;
</script>

</body>
</html>
